#!/bin/bash
# WARNING: this script will destroy data on the selected disk.
# This script can be run by executing the following:
#   curl -sL https://git.io/vAoV8 | bash


################# GLOBAL BATCH SETTINGS #################

partition_type="ALL_IN_ONE_DRIVE"
locale="en_GB.UTF-8 UTF-8"
keyboard_layout="uk"
mirror_list_url="https://www.archlinux.org/mirrorlist/?country=GB&protocol=https&use_mirror_status=on"
timezone="Europe/London"
echo "[baraud]" >> ./baraud_mirror
echo "SigLevel = Optional TrustAll" >> ./baraud_mirror
echo "Server = https://arch-mirror.baraud.fr" >> ./baraud_mirror
private_mirror="./baraud_mirror"
package_list=baraud-base baraud-desktop

manage_error_during_install(){
	set -uo pipefail
	trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR
	### Set up logging ###
	exec 1> >(tee "stdout.log")
	exec 2> >(tee "stderr.log")
}

################# HARD DRIVE PARTITION #################

get_partition_template(){
	[[ -z $partition_type ]] && partition_type=$(dialog --stdout --menu "Select partition_type" 0 0 0 "ALL_IN_ONE_DRIVE" "/home and /root share same drive" "SEPARATED_HOME" "/home will be on a dedicated drive" )
}

is_uefi() {
	ls /sys/firmware/efi/efivars &> /dev/null
}

get_drive_to_install(){
	devicelist=$(lsblkrrrplnx size -o name,size | grep -Ev "boot|rpmb|loop" | tac)
	device=$(dialog --stdout --menu "Select installtion disk" 0 0 0 ${devicelist}) || exit 1
}

format_all_in_one_drive_uefi(){
	[[ -z device ]] && get_drive_to_install
	swap_size=$(free --mebi | awk '/Mem:/ {print $2}')
	swap_end=$(( $swap_size + 129 + 1 ))MiB

	parted --script "${device}" -- mklabel gpt \
	  mkpart ESP fat32 1Mib 129MiB \
	  set 1 boot on \
	  mkpart primary linux-swap 129MiB ${swap_end} \
	  mkpart primary ext4 ${swap_end} 100%

	part_boot="$(ls ${device}* | grep -E "^${device}p?1$")"
	part_swap="$(ls ${device}* | grep -E "^${device}p?2$")"
	part_root="$(ls ${device}* | grep -E "^${device}p?3$")"

	wipefs "${part_boot}"
	wipefs "${part_swap}"
	wipefs "${part_root}"

	mkfs.vfat -F32 "${part_boot}"
	mkswap "${part_swap}"
	mkfs.f2fs -f "${part_root}"

	swapon "${part_swap}"
	mount "${part_root}" /mnt
	mkdir /mnt/boot
	mount "${part_boot}" /mnt/boot
}

format_all_in_one_drive_bios(){
	[[ -z device ]] && get_drive_to_install
	swap_size=$(free --mebi | awk '/Mem:/ {print $2}')
	swap_end=$(( $swap_size + 1 ))MiB

	parted --script "${device}" -- mklabel msdos \
	  mkpart primary linux-swap 1MiB ${swap_end} \
	  mkpart primary ext4 ${swap_end} 100% \
	  set 2 boot on

	part_swap="$(ls ${device}* | grep -E "^${device}p?1$")"
	part_root="$(ls ${device}* | grep -E "^${device}p?2$")"

	wipefs "${part_swap}"
	wipefs "${part_root}"

	mkswap "${part_swap}"
	mkfs.ext4 "${part_root}"

	swapon "${part_swap}"
	mount "${part_root}" /mnt
}

format_with_sepatate_home_uefi(){
	echo "Format with separate home is not supported yet"
	exit 1
}

format_with_sepatate_home_bios(){
	echo "Format with separate home is not supported yet"
	exit 1
}

partition_hard_drive(){
	get_partition_template
	[[ "$partition_type" == "ALL_IN_ONE_DRIVE" ]] && { is_uefi && format_all_in_on_drive_uefi || format_all_in_on_drive_bios }
	[[ "$partition_type" == "SEPARATED_HOME" ]] && { is_uefi && format_with_separate_home_uefi || format_with_separate_home_bios }
	[[ "$partition_type" == "ALL_IN_ONE_DRIVE" ]] || [[ "$partition_type" == "SEPARATED_HOME" ]] || { echo "Unknow partition_type $partition_type, should be either ALL_IN_ONE_DRIVE or SEPARATED_HOME" && exit 1  }
}

################# INSTALL LINUX #################

# -------------- NETWORK ----------------#

get_hostname(){
	hostname=$(dialog --stdout --inputbox "Enter hostname" 0 0) || exit 1
	clear
	: ${hostname:?"hostname cannot be empty"}
}

set_hostname(){
	[[ -z $hostname ]] && get_hostname
	echo "${hostname}" > /mnt/etc/hostname
}

# -------------- LOCALES ----------------#

get_locale(){
	locale_list=$(cut -d '#' -f2 /etc/locale.gen)
	locale=$(dialog --stdout --menu "Select locale computer" $locale_list 0 0 0  )
}

get_keyboard_layout(){
	keyboard_layout_list=$(ls /usr/share/kbd/keymaps/**/*.map.gz | sed 's:\(.*\)/\(.*\)\.map\.gz:\2 (\1):')
	keyboard_layout=$(dialog --stdout --menu "Select keyboard layout" $keyboard_layout_list 0 0 0  )
}

get_timezone(){
	timezone_list=$(ls /usr/share/kbd/keymaps/**/*.map.gz | sed 's:\(.*\)/\(.*\)\.map\.gz:\2 (\1):')
	timezone=$(dialog --stdout --menu "Select a timezone" $timezone_list 0 0 0  )
}

generate_locales(){
	[[ -z $locale ]] && get_locale
	[[ -z $keyboard_layout ]] get_keyboard_layout
	[[ -z $timezone ]] get_timezone
	echo $locale >> /mnt/etc/locale.gen
	echo $keyboard_layout >> /mnt/etc/vconsole.conf
	arch-chroot /mnt ln -sf "/usr/share/zoneinfo/$timezone" /etc/localtime
	arch-chroot /mnt locale-gen
	arch-chroot /mnt hwclock --systohc
	loadkeys $keyboard_layout
}


# -------------- PACKAGES ----------------#

update_mirror_list(){
	pacman -Sy --no-confirm pacman-contrib
	curl -s "$mirror_list_url" | \
	    sed -e 's/^#Server/Server/' -e '/^#/d' | \
	    rankmirrors -n 5 - > /etc/pacman.d/mirrorlist
	pacman -Sy
	cp /etc/pacman.d/mirrorlist /mnt/etc/pacman.d/mirrorlist
}

update_private_mirror(){
	cat /etc/pacman.conf $private_mirror > /etc/pacman.conf
	cat /mnt/pacman.conf $private_mirror > /mnt/etc/pacman.conf
	pacman -Sy
}

update_repo() {
	[[ -n $mirror_list_url ]] && update_mirror_list
	[[ -n $private_mirror ]] && update_private_mirror
        pacman -Sy
}

install_packages(){
	update_repo
	[[ -z $package_list ]] package_list="base linux linux-firmware"
	pacstrap /mnt $package_list
}

# -------------- USER ----------------#

get_username(){
	user=$(dialog --stdout --inputbox "Enter admin username" 0 0) || exit 1
	clear
	: ${user:?"user cannot be empty"}
}

get_password(){
	message="Please enter admin password"
	while [[ -n $password1 && -n $password2 && $password1 == $password2 ]]; do
		password=$(dialog --stdout --passwordbox "$message" 0 0) || exit 1
		clear
		: ${password:?"password cannot be empty"}
		password2=$(dialog --stdout --passwordbox "Enter admin password again" 0 0) || exit 1
		clear
		message="Password did not matched"
	end
}

add_user(){
	[[ -z $user ]] && get_username
	[[ -z $password ]] && get_password
	[[ -z $shell ]] && /bin/sh
	arch-chroot /mnt useradd -mU -s "$shell" -G wheel,uucp,video,audio,storage,games,input "$user"
	arch-chroot /mnt chsh -s $shell
	echo "$user ALL=(ALL:ALL) ALL" >> /mnt/etc/sudoers
	echo "$user:$password" | chpasswd --root /mnt
	echo "root:$password" | chpasswd --root /mnt
}


# -------------- CONFIG ----------------#

add_config(){
}

# --------------- BOOTLOADER ------------#

install_bootloader_uefi(){
       arch-chroot /mnt bootctl install
       echo "default arch" > /mnt/boot/loader/loader.conf
       echo "title    Arch Linux" > /mnt/boot/loader/entries/arch.conf
       echo "linux    /vmlinuz-linux" >> /mnt/boot/loader/entries/arch.conf
       echo "initrd   /initramfs-linux.img" >> /mnt/boot/loader/entries/arch.conf
       echo "options  root=PARTUUID=$(blkid -s PARTUUID -o value "$part_root") rw" >> /mnt/boot/loader/entries/arch.conf
}

install_bootloader_bios(){
       arch-chroot /mnt pacman -Sy grub
       arch-chroot /mnt grub-install --target=i386-pc "${device}"
       arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
}

install_bootloader(){
	genfstab -t PARTUUID /mnt >> /mnt/etc/fstab
	is_uefi && install_bootloader_uefi || install_bootloader_bios
}

# -------------- INSTALL ----------------#

manage_error_during_install && \
partition_hard_drive && \
generate_locales && \
set_hostname && \
install_packages && \
install_bootloader && \
add_user && \
add_config
