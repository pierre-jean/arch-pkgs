#!/bin/bash
# WARNING: this script will destroy data on the selected disk.
# This script can be run by executing the following:
#   curl -sL https://git.io/vAoV8 | bash

script_setup(){
	set -uo pipefail
	trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR
	### Set up logging ###
	exec 1> >(tee "stdout.log")
	exec 2> >(tee "stderr.log")
}

update_repo() {
	MIRRORLIST_URL="https://www.archlinux.org/mirrorlist/?country=GB&protocol=https&use_mirror_status=on"

	pacman -Sy --noconfirm pacman-contrib
	
	echo "Updating mirror list"
	curl -s "$MIRRORLIST_URL" | \
	    sed -e 's/^#Server/Server/' -e '/^#/d' | \
	    rankmirrors -n 5 - > /etc/pacman.d/mirrorlist
	cat >>/etc/pacman.conf <<EOF
	[baraud]
	SigLevel = Optional TrustAll
	Server = https://arch-mirror.baraud.fr
EOF
        
        pacman -Sy
}

update_repo_final_machine() {
	cat >>/mnt/etc/pacman.conf <<EOF
	[baraud]
	SigLevel = Optional TrustAll
	Server = https://arch-mirror.baraud.fr
EOF

	arch-chroot /mnt/ pacman -Sy 
}

ask_password(){
	password=$(dialog --stdout --passwordbox "Enter admin password" 0 0) || exit 1
	clear
	: ${password:?"password cannot be empty"}
	password2=$(dialog --stdout --passwordbox "Enter admin password again" 0 0) || exit 1
	clear

}

select_options(){
	loadkeys uk
	hostname=$(dialog --stdout --inputbox "Enter hostname" 0 0) || exit 1
	clear
	: ${hostname:?"hostname cannot be empty"}

	user=$(dialog --stdout --inputbox "Enter admin username" 0 0) || exit 1
	clear
	: ${user:?"user cannot be empty"}

	ask_password

	[[ "$password1" == "$password2"]] || ask_password

	devicelist=$(lsblk -dplnx size -o name,size | grep -Ev "boot|rpmb|loop" | tac)
	device=$(dialog --stdout --menu "Select installtion disk" 0 0 0 ${devicelist}) || exit 1
	clear

	packages_availables="\
		baraud-base command-line on\
		baraud-desktop graphical-env off"

	packages_to_install=$(dialog --stdout --checklist "Select packages to install" 0 0 0 "$(<$packages_availables)")
}

is_uefi() {
	ls /sys/firmware/efi/efivars &> /dev/null
}

format_uefi(){
	swap_size=$(free --mebi | awk '/Mem:/ {print $2}')
	swap_end=$(( $swap_size + 129 + 1 ))MiB

	parted --script "${device}" -- mklabel gpt \
	  mkpart ESP fat32 1Mib 129MiB \
	  set 1 boot on \
	  mkpart primary linux-swap 129MiB ${swap_end} \
	  mkpart primary ext4 ${swap_end} 100%

	part_boot="$(ls ${device}* | grep -E "^${device}p?1$")"
	part_swap="$(ls ${device}* | grep -E "^${device}p?2$")"
	part_root="$(ls ${device}* | grep -E "^${device}p?3$")"

	wipefs "${part_boot}"
	wipefs "${part_swap}"
	wipefs "${part_root}"

	mkfs.vfat -F32 "${part_boot}"
	mkswap "${part_swap}"
	mkfs.f2fs -f "${part_root}"

	swapon "${part_swap}"
	mount "${part_root}" /mnt
	mkdir /mnt/boot
	mount "${part_boot}" /mnt/boot
}

format_bios(){
	swap_size=$(free --mebi | awk '/Mem:/ {print $2}')
	swap_end=$(( $swap_size + 1 ))MiB

	parted --script "${device}" -- mklabel msdos \
	  mkpart primary linux-swap 1MiB ${swap_end} \
	  mkpart primary ext4 ${swap_end} 100% \
	  set 2 boot on

	part_swap="$(ls ${device}* | grep -E "^${device}p?1$")"
	part_root="$(ls ${device}* | grep -E "^${device}p?2$")"

	wipefs "${part_swap}"
	wipefs "${part_root}"

	mkswap "${part_swap}"
	mkfs.ext4 "${part_root}"

	swapon "${part_swap}"
	mount "${part_root}" /mnt
}

generate_locales(){
	echo "en_GB.UTF-8 UTF-8" >> /mnt/etc/locale.gen
	echo "KEYMAP=uk" >> /mnt/etc/vconsole.conf
	arch-chroot /mnt locale-gen
}

install_bootloader_uefi(){
	arch-chroot /mnt bootctl install
	cat <<EOF > /mnt/boot/loader/loader.conf
	default arch
	EOF

	cat <<EOF > /mnt/boot/loader/entries/arch.conf
	title    Arch Linux
	linux    /vmlinuz-linux
	initrd   /initramfs-linux.img
	options  root=PARTUUID=$(blkid -s PARTUUID -o value "$part_root") rw
EOF
}

install_bootloader_bios(){
	arch-chroot /mnt grub-install --target=i386-pc "${device}"
	arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
}

install_packages(){
	pacstrap /mnt linux linux-firmware $packages_to_install
}



script_setup
update_repo
select_options
timedatectl set-ntp true
is_uefi && format_uefi || format_bios
install_packages
update_repo_final_machine

genfstab -t PARTUUID /mnt >> /mnt/etc/fstab

is_uefi && install_bootloader_uefi || install_bootloader_bios

generate_locales

arch-chroot /mnt useradd -mU -s /usr/bin/zsh -G wheel,uucp,video,audio,storage,games,input "$user"
arch-chroot /mnt chsh -s /usr/bin/zsh
arch-chroot /mnt ln -sf /usr/share/zoneinfo/Europe/London /etc/localtime
arch-chroot /mnt systemctl enable dhcpcd

echo "exec bspwm" > /mnt/home/$user/.xinitrc

echo "${hostname}" > /mnt/etc/hostname
echo "$user ALL=(ALL:ALL) ALL" >> /mnt/etc/sudoers

echo "$user:$password" | chpasswd --root /mnt
echo "root:$password" | chpasswd --root /mnt
